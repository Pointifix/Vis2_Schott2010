<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - volume rendering example</title>
    <meta charset="utf-8">
    <meta content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
    <link href="main.css" rel="stylesheet" type="text/css">
</head>

<body>
<div id="info">
    <a href="https://threejs.org" rel="noopener" target="_blank">three.js</a> - Float volume render test (mip /
    isosurface)
</div>
<div id="container"></div>
<div id="inset"></div>
<script type="module">
    import * as THREE from './build/three.module.js';
    import {OrbitControls} from './js/controls/OrbitControls.js';
    import Stats from './js/libs/stats.module.js';
    import {WEBGL} from './js/WebGL.js';
    import {GUIManager} from "./js/GUIManager.js";
    import {VolumeManager} from "./js/VolumeManager.js";
    import {ProxyGeometryGenerator} from "./js/ProxyGeometryGenerator.js";
    import {VolumeShader} from "./js/shaders/VolumeShader/VolumeShader.js";
    import * as CONSTANTS from "./js/Constants.js";

    if (WEBGL.isWebGL2Available() === false) {
        document.body.appendChild(WEBGL.getWebGL2ErrorMessage());
    }

    let renderer, camera, controls, stats, container;

    let guiManager;
    let volumeManager;
    let proxyGeometryGenerator;

    let volumeShader;
    let volumeShaderMaterial;

    let renderTargets = new Array(2);
    let currentRenderTarget = false;

    let scenes = [CONSTANTS.MAX_SLICES_COUNT];

    init();
    animate();

    function init() {
        for (let i = 0; i < CONSTANTS.MAX_SLICES_COUNT; i++) {
            scenes[i] = new THREE.Scene();
        }

        //Renderer
        container = document.getElementById("container");
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('webgl2', {alpha: true, antialias: false});
        renderer = new THREE.WebGLRenderer({canvas: canvas, context: context, preserveDrawingBuffer: true});
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        //Camera
        let h = 512;
        let aspect = window.innerWidth / window.innerHeight;
        camera = new THREE.OrthographicCamera(-h * aspect / 2, h * aspect / 2, h / 2, -h / 2, -1000, 1000);

        //Controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.update();

        //Volume Shader
        volumeShader = VolumeShader;
        let uniforms = THREE.UniformsUtils.clone(volumeShader.uniforms);

        volumeShaderMaterial = new THREE.ShaderMaterial({
            uniforms: uniforms,
            vertexShader: volumeShader.vertexShader,
            fragmentShader: volumeShader.fragmentShader,
            side: THREE.DoubleSide
        });

        volumeShaderMaterial.uniforms["u_screen_size"].value = new THREE.Vector2(window.innerWidth, window.innerHeight);


        //Managers
        proxyGeometryGenerator = new ProxyGeometryGenerator();
        volumeManager = new VolumeManager(camera, controls, volumeShaderMaterial);
        guiManager = new GUIManager();

        //Framebuffer
        renderTargets[0] = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);
        renderTargets[1] = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);

        let i = 0;
        proxyGeometryGenerator.geometries.forEach(geometry => {
            let proxyMesh = new THREE.Mesh(geometry, volumeShaderMaterial);
            scenes[i].add(proxyMesh);
            i++;
        });

        //Stats
        stats = new Stats();
        container.appendChild(stats.dom);

        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        renderer.setSize(window.innerWidth, window.innerHeight);
        let aspect = window.innerWidth / window.innerHeight;

        renderTargets[0] = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);
        renderTargets[1] = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);

        volumeShaderMaterial.uniforms["u_screen_size"].value = new THREE.Vector2(window.innerWidth, window.innerHeight);

        let frustumHeight = camera.top - camera.bottom;

        camera.left = -frustumHeight * aspect / 2;
        camera.right = frustumHeight * aspect / 2;

        camera.updateProjectionMatrix();
    }

    function animate() {
        requestAnimationFrame(animate);

        if (!(proxyGeometryGenerator.box === undefined)) proxyGeometryGenerator.updateProxyGeometries(camera);

        controls.update();

        render();
        stats.update();
    }

    function render() {
        //f2b
        for (let i = 0; i < 30; i++) {

            volumeShaderMaterial.uniforms["u_prev"].value = renderTargets[!currentRenderTarget | 0].texture;

            renderer.setRenderTarget(renderTargets[currentRenderTarget | 0]);

            renderer.autoClear = false;
            renderer.render(scenes[i], camera);
            currentRenderTarget = !currentRenderTarget;
            renderer.autoClear = false;
        }

        renderer.autoClear = false;

        volumeShaderMaterial.uniforms["u_prev"].value = renderTargets[!currentRenderTarget | 0].texture;
        renderer.setRenderTarget(null);

        renderer.autoClear = false;
        renderer.render(scenes[30], camera);




        //b2f
        /*
        for (let i = proxyGeometryGenerator.sliceIndex; i > proxyGeometryGenerator.focalPlaneIndex; i--) {

            volumeShaderMaterial.uniforms["u_prev"].value = renderTargets[!currentRenderTarget | 0].texture;

            renderer.setRenderTarget(renderTargets[currentRenderTarget | 0]);

            renderer.render(scenes[i], camera);
            currentRenderTarget = !currentRenderTarget;
        }*/

        /*
        volumeShaderMaterial.uniforms["u_prev"].value = renderTargets[!currentRenderTarget | 0].texture;
        renderer.setRenderTarget(null);
        renderer.render(scenes[proxyGeometryGenerator.focalPlaneIndex], camera);*/

        stats.update();
    }
</script>
</body>
</html>
